{% extends "feedback_layout.html" %}

{% set guidanceTitle =  'Citizen feedback (not moderated)' %}
{% set isCitizenFeedback =  "true" %}
{% set hideBackLink =  "yes" %}

{% block pageTitle %}
  Citizen feedback - Apply for a Blue Badge
{% endblock %}

{% block guidance_content %}

<div id="feedbackContainer"></div>

<p class="" id="feedbackDateRange"></p>

{% if data['auto-refresh'] !== "true" %}
  <a href="?auto-refresh=true">30 sec auto-refresh</a>
{% else %}
  <div class="feedback-countdown-container">
    <a href="?auto-refresh=false">Turn off auto-refresh</a>
    <div class="countdown-container">
      <a href="" class="pause-button">
        <svg id="icon-pause" viewBox="0 0 32 32">
        <title>Pause countdown</title>
        <path d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16zM16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM10 10h4v12h-4zM18 10h4v12h-4z"></path>
        </svg>
      </a>
      <a href="" class="play-button" style="display: none;">
        <svg id="icon-pause" viewBox="0 0 32 32">
        <title>Restart countdown</title>
        <path d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16zM16 29c-7.18 0-13-5.82-13-13s5.82-13 13-13 13 5.82 13 13-5.82 13-13 13zM12 9l12 7-12 7z"></path>
        </svg>
      </a>
      <p class="countdown-visual govuk-body" id="countdownVisual">30</p>
    </div>
  </div>
{% endif %}

{% endblock %}

{% block pageScripts %}

  <script src="/public/javascripts/moment.js"></script>

  {% if data['auto-refresh'] === "true" %}
    <script>
      var $countdownVisual = $('#countdownVisual'),
          countdownTime = Number($countdownVisual.text()),
          isPaused = false,
          counter = 0,
          interval = setInterval(function() {
                      if(!isPaused) {
                          counter++;
                          $countdownVisual.text(countdownTime - counter);
                          if (counter == 30) {
                              //Refreshes the window
                              document.location.reload(true)
                          }
                        }
                    }, 1000);

      $('.pause-button').on('click', function(e) {
        e.preventDefault();

        isPaused = true;

        $(this).hide();
        $('.play-button').show();
      });

      $('.play-button').on('click', function(e) {
        e.preventDefault();

        isPaused = false;
        $(this).hide();
        $('.pause-button').show();
      });
      
    </script>
  {% endif %}
  <script>
    $(document).ready(function () {
      function randomIntFromInterval(min,max)
      {
          return Math.floor(Math.random()*(max-min+1)+min);
      }

      function convertDigitIn(str){
         return str.split('/').reverse().join('-');
      }

      var rangeStart = randomIntFromInterval(2,8075),
          rangeEnd = rangeStart + 4, 
          range = "C"+rangeStart+":C"+rangeEnd,
          timerange = "A"+rangeStart+":A"+rangeEnd,
          sheetsURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!"+range+"?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          timesURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!"+timerange+"?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          datesURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!A2:A?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          scoreURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Satisfaction%20Score!B4?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8";

      $.getJSON( timesURL, {
        
      }).done(function( data ) {
        var values = data.values,
                    startDate = values[0],
                    justDate = startDate.toString().slice(0, -6),
                    reversedDate = convertDigitIn(justDate),
                    formattedDate = moment(reversedDate).format('ddd D MMM YYYY'); 

                $('#feedbackContainer').prepend('<p class="govuk-body-l"><small>5 responses from ' + formattedDate + '</small>');
      });

      $.getJSON( sheetsURL, {
        
      }).done(function( data ) {
        $.each( data.values, function( i, value ) {
          var feedback = value[0].replace('â€™', '\'').replace('â€™',  '\'');

          if(feedback.indexOf('Rating of') >= 0 ||
             feedback.length < 4  ||
             feedback == 'apply-blue-badge' ){
            $('#feedbackContainer').append('<p class="govuk-body-l" data-removed-text><i>Text removed</i></p>');
            if($('[data-removed-text]').length > 2) {
              window.setTimeout(function(){ document.location.reload(true); }, 2000)
            }
          } else {
            $('#feedbackContainer').append('<p class="govuk-body-l">“' + feedback + '”</p>');
          }
        });
      });

      $.getJSON( datesURL, {
        
      }).done(function( data ) {
        var values = data.values,
            startDate = values[0],
            responseLength = values.length-1,
            endDate = values[responseLength];

        $('#feedbackDateRange').html("<small>" + responseLength + " responses from " + startDate + " to " + endDate + "</small>");
      });

      $.getJSON( scoreURL, {
        
      }).done(function( data ) {
        $.each( data.values, function( i, value ) {
          var score = value[0];
          
          $('#satisfactionScore').html(score);
        });
      });

    });
  </script>
{% endblock %}