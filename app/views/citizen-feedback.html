{% extends "guidance_layout.html" %}

{% set guidanceTitle =  'Citizen feedback (unmoderated)' %}
{% set hidesSteps =  "true" %}
{% set isCitizenFeedback =  "true" %}
{% set hideBackLink =  "yes" %}

{% block pageTitle %}
  Citizen feedback - Apply for a Blue Badge
{% endblock %}

{% block guidance_content %}

<div id="feedbackContainer"></div>

{% if data['auto-refresh'] !== "true" %}
  <a href="?auto-refresh=true">30 sec auto-refresh</a>
{% else %}
  <a href="?auto-refresh=false">Turn off auto-refresh</a>
{% endif %}

{% endblock %}

{% block pageScripts %}

  {% if data['auto-refresh'] === "true" %}
    <script>
      window.setTimeout(function(){ document.location.reload(true); }, 30000);
      //Refreshes the window
    </script>
  {% endif %}
  <script>
    $(document).ready(function () {
      function randomIntFromInterval(min,max)
      {
          return Math.floor(Math.random()*(max-min+1)+min);
      }

      var rangeStart = randomIntFromInterval(2,5909),
          rangeEnd = rangeStart + 4, 
          range = "C"+rangeStart+":C" +rangeEnd,
          sheetsURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!"+range+"?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          datesURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!A2:A?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          scoreURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Satisfaction%20Score!B4?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8";

      $.getJSON( sheetsURL, {
        
      })
      .done(function( data ) {
        $.each( data.values, function( i, value ) {
          var feedback = value[0].replace('â€™', '\'').replace('â€™',  '\'');

          if(feedback.indexOf('Rating of') >= 0 || feedback.indexOf('N/A') >= 0) {
            $('#feedbackContainer').append('<p class="govuk-body-l"><i>Text removed</i></p>');
          } else {
            $('#feedbackContainer').append('<p class="govuk-body-l">"' + feedback + '"</p>');
          }
          
        });
      });

      $.getJSON( datesURL, {
        
      })
      .done(function( data ) {

        var values = data.values,
            startDate = values[0],
            endDate = values[values.length-1];

        $('#feedbackDateRange').html("<small>Showing 5 samples from " + startDate + " to " + endDate + "</small>");
      });


      $.getJSON( scoreURL, {
        
      })
      .done(function( data ) {
        $.each( data.values, function( i, value ) {
          var score = value[0];
          
          $('#satisfactionScore').html(score);
        });
      });

    });
  </script>
{% endblock %}