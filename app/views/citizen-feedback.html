{% extends "feedback_layout.html" %}

{% set guidanceTitle =  'Citizen feedback (not moderated)' %}
{% set isCitizenFeedback =  "true" %}
{% set hideBackLink =  "yes" %}

{% block pageTitle %}
  Citizen feedback - Apply for a Blue Badge
{% endblock %}

{% block guidance_content %}

<div id="feedbackContainer"></div>

<p class="" id="feedbackDateRange"></p>

{% if data['auto-refresh'] !== "true" %}
  <a href="?auto-refresh=true">30 sec auto-refresh</a>
{% else %}
  <a href="?auto-refresh=false">Turn off auto-refresh</a>
{% endif %}

{% endblock %}

{% block pageScripts %}

  <script src="/public/javascripts/moment.js"></script>

  {% if data['auto-refresh'] === "true" %}
    <script>
      window.setTimeout(function(){ document.location.reload(true); }, 30000);
      //Refreshes the window
    </script>
  {% endif %}
  <script>
    $(document).ready(function () {
      function randomIntFromInterval(min,max)
      {
          return Math.floor(Math.random()*(max-min+1)+min);
      }

      function convertDigitIn(str){
         return str.split('/').reverse().join('-');
      }

      var rangeStart = randomIntFromInterval(2,5909),
          rangeEnd = rangeStart + 4, 
          range = "C"+rangeStart+":C"+rangeEnd,
          timerange = "A"+rangeStart+":A"+rangeEnd,
          sheetsURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!"+range+"?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          timesURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!"+timerange+"?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          datesURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Feedback!A2:A?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8",
          scoreURL = "https://sheets.googleapis.com/v4/spreadsheets/1X2YzQ1p2UZ9pGUCg-hhRNOCZhhRPl_26ZrKZ7i68xYE/values/Satisfaction%20Score!B4?key=AIzaSyBzN8Fujbz24ZzMZX7E8jx9aPkJ2JcYO_8";

      $.getJSON( timesURL, {
        
      }).done(function( data ) {
        var values = data.values,
                    startDate = values[0],
                    justDate = startDate.toString().slice(0, -6),
                    reversedDate = convertDigitIn(justDate),
                    formattedDate = moment(reversedDate).format('ddd D MMM YYYY'); 

                $('#feedbackContainer').prepend('<p class="govuk-body-l"><small>5 responses from ' + formattedDate + '</small>');
      });

      $.getJSON( sheetsURL, {
        
      }).done(function( data ) {
        $.each( data.values, function( i, value ) {
          var feedback = value[0].replace('â€™', '\'').replace('â€™',  '\'');

          if(feedback.indexOf('Rating of') >= 0 ||
             feedback == 'N/A' ||
             feedback == 'na' ){
            $('#feedbackContainer').append('<p class="govuk-body-l"><i>Text removed</i></p>');
          } else {
            $('#feedbackContainer').append('<p class="govuk-body-l">"' + feedback + '"</p>');
          }
        });
      });

      $.getJSON( datesURL, {
        
      }).done(function( data ) {
        var values = data.values,
            startDate = values[0],
            responseLength = values.length-1,
            endDate = values[responseLength];

        $('#feedbackDateRange').html("<small>" + responseLength + " responses from " + startDate + " to " + endDate + "</small>");
      });

      $.getJSON( scoreURL, {
        
      }).done(function( data ) {
        $.each( data.values, function( i, value ) {
          var score = value[0];
          
          $('#satisfactionScore').html(score);
        });
      });

    });
  </script>
{% endblock %}